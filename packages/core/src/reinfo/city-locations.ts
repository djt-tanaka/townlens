import { geocodeCityName } from "./geocode";

/** 市区町村の代表地点（市役所・区役所の緯度経度） */
export interface CityLocation {
  readonly name: string;
  readonly lat: number;
  readonly lng: number;
}

/**
 * 主要市区町村の代表地点マップ。
 * キーは市区町村コード（5桁）。値は市区町村名と市役所/区役所の緯度経度。
 * 未登録の市区町村は --no-disaster で対応する。
 */
const LOCATIONS: ReadonlyArray<readonly [string, string, number, number]> = [
  // 東京都23区
  ["13101", "千代田区", 35.6938, 139.7035],
  ["13102", "中央区", 35.6748, 139.7716],
  ["13103", "港区", 35.6581, 139.7514],
  ["13104", "新宿区", 35.6938, 139.7036],
  ["13105", "文京区", 35.7131, 139.7300],
  ["13106", "台東区", 35.7021, 139.7745],
  ["13107", "墨田区", 35.7101, 139.8017],
  ["13108", "江東区", 35.6727, 139.8171],
  ["13109", "品川区", 35.7328, 139.7178],
  ["13110", "目黒区", 35.6585, 139.7151],
  ["13111", "大田区", 35.5614, 139.7160],
  ["13112", "世田谷区", 35.6464, 139.6538],
  ["13113", "渋谷区", 35.6640, 139.6982],
  ["13114", "中野区", 35.7148, 139.6621],
  ["13115", "杉並区", 35.6994, 139.6364],
  ["13116", "豊島区", 35.7326, 139.6531],
  ["13117", "北区", 35.7518, 139.7160],
  ["13118", "荒川区", 35.7530, 139.7501],
  ["13119", "板橋区", 35.7389, 139.8015],
  ["13120", "練馬区", 35.7353, 139.6519],
  ["13121", "足立区", 35.7717, 139.8500],
  ["13122", "葛飾区", 35.7431, 139.8487],
  ["13123", "江戸川区", 35.7065, 139.8686],
  // 東京都市部
  ["13201", "八王子市", 35.6839, 139.5594],
  ["13202", "立川市", 35.7101, 139.5243],
  ["13203", "武蔵野市", 35.6716, 139.4761],
  ["13204", "三鷹市", 35.6836, 139.5592],
  ["13210", "町田市", 35.6487, 139.5416],
  // 神奈川県
  ["14100", "横浜市", 35.4478, 139.6425],
  ["14130", "川崎市", 35.5313, 139.7030],
  ["14150", "相模原市", 35.3294, 139.5501],
  ["14201", "横須賀市", 35.3398, 139.0901],
  ["14204", "藤沢市", 35.3413, 139.3451],
  // 埼玉県
  ["11100", "さいたま市", 35.8617, 139.6455],
  ["11201", "川越市", 35.9076, 139.4812],
  ["11202", "熊谷市", 35.9613, 139.5889],
  ["11203", "川口市", 35.8340, 139.7188],
  // 千葉県
  ["12100", "千葉市", 35.6073, 140.1063],
  ["12203", "市川市", 35.7564, 139.8743],
  ["12204", "船橋市", 35.7104, 139.9973],
  ["12207", "松戸市", 35.7815, 139.8903],
  ["12217", "柏市", 35.8676, 139.9709],
  // 大阪府
  ["27100", "大阪市", 34.6937, 135.5023],
  ["27140", "堺市", 34.8042, 135.5943],
  ["27202", "豊中市", 34.8186, 135.5146],
  ["27203", "池田市", 34.7549, 135.4543],
  ["27204", "吹田市", 34.7609, 135.5613],
  ["27205", "泉大津市", 34.7525, 135.6073],
  ["27207", "高槻市", 34.8514, 135.6001],
  ["27210", "茨木市", 34.8152, 135.5731],
  ["27227", "東大阪市", 34.6460, 135.5960],
  // 愛知県
  ["23100", "名古屋市", 35.1815, 136.9066],
  ["23201", "豊橋市", 34.9560, 136.9116],
  ["23202", "岡崎市", 34.9662, 137.1620],
  ["23204", "春日井市", 35.2514, 136.9686],
  ["23211", "豊田市", 35.0842, 136.9789],
  // 福岡県
  ["40100", "福岡市", 33.5904, 130.4017],
  ["40130", "北九州市", 33.8835, 130.8753],
  ["40203", "久留米市", 33.3154, 130.5088],
  // 北海道
  ["01100", "札幌市", 43.0621, 141.3544],
  ["01202", "旭川市", 43.7696, 142.3650],
  ["01203", "小樽市", 42.9849, 141.0145],
  // 宮城県
  ["04100", "仙台市", 38.2682, 140.8694],
  // 広島県
  ["34100", "広島市", 34.3963, 132.4596],
  // 京都府
  ["26100", "京都市", 35.0116, 135.7681],
  // 兵庫県
  ["28100", "神戸市", 34.6901, 135.1956],
  ["28201", "姫路市", 34.7353, 135.3433],
  ["28202", "尼崎市", 34.7371, 135.4064],
  ["28204", "西宮市", 34.7975, 135.3607],
  // 静岡県
  ["22100", "静岡市", 34.9769, 138.3831],
  ["22130", "浜松市", 34.7108, 137.7261],
  // 新潟県
  ["15100", "新潟市", 37.9161, 139.0364],
  // 岡山県
  ["33100", "岡山市", 34.6618, 133.9350],
  // 熊本県
  ["43100", "熊本市", 32.7898, 130.7417],
];

export const CITY_LOCATIONS: ReadonlyMap<string, CityLocation> = new Map(
  LOCATIONS.map(([code, name, lat, lng]) => [code, { name, lat, lng }]),
);

/** ランタイムキャッシュ（ジオコーディング結果を保持） */
const runtimeCache = new Map<string, CityLocation>();

/** 市区町村コードから代表地点を取得する。未登録の場合はnullを返す。 */
export function getCityLocation(areaCode: string): CityLocation | null {
  return CITY_LOCATIONS.get(areaCode) ?? runtimeCache.get(areaCode) ?? null;
}

/**
 * 市区町村コードから代表地点を取得する（非同期版）。
 * 静的テーブルに無い場合、cityNameが指定されていれば国土地理院APIでフォールバック取得する。
 */
export async function getCityLocationAsync(
  areaCode: string,
  cityName?: string,
): Promise<CityLocation | null> {
  const cached = getCityLocation(areaCode);
  if (cached) {
    return cached;
  }

  if (!cityName) {
    return null;
  }

  const location = await geocodeCityName(cityName);
  if (location) {
    runtimeCache.set(areaCode, location);
    return location;
  }
  return null;
}
