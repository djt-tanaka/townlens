import { geocodeCityName } from "./geocode";

/** 市区町村の代表地点（市役所・区役所の緯度経度） */
export interface CityLocation {
  readonly lat: number;
  readonly lng: number;
}

/**
 * 主要市区町村の代表地点マップ。
 * キーは市区町村コード（5桁）。値は市役所/区役所の緯度経度。
 * 未登録の市区町村は --no-disaster で対応する。
 */
const LOCATIONS: ReadonlyArray<readonly [string, number, number]> = [
  // 東京都23区
  ["13101", 35.6938, 139.7035], // 千代田区
  ["13102", 35.6748, 139.7716], // 中央区
  ["13103", 35.6581, 139.7514], // 港区
  ["13104", 35.6938, 139.7036], // 新宿区
  ["13105", 35.7131, 139.7300], // 文京区
  ["13106", 35.7021, 139.7745], // 台東区
  ["13107", 35.7101, 139.8017], // 墨田区
  ["13108", 35.6727, 139.8171], // 江東区
  ["13109", 35.7328, 139.7178], // 品川区
  ["13110", 35.6585, 139.7151], // 目黒区
  ["13111", 35.5614, 139.7160], // 大田区
  ["13112", 35.6464, 139.6538], // 世田谷区
  ["13113", 35.6640, 139.6982], // 渋谷区
  ["13114", 35.7148, 139.6621], // 中野区
  ["13115", 35.6994, 139.6364], // 杉並区
  ["13116", 35.7326, 139.6531], // 豊島区
  ["13117", 35.7518, 139.7160], // 北区
  ["13118", 35.7530, 139.7501], // 荒川区
  ["13119", 35.7389, 139.8015], // 板橋区
  ["13120", 35.7353, 139.6519], // 練馬区
  ["13121", 35.7717, 139.8500], // 足立区
  ["13122", 35.7431, 139.8487], // 葛飾区
  ["13123", 35.7065, 139.8686], // 江戸川区
  // 東京都市部
  ["13201", 35.6839, 139.5594], // 八王子市
  ["13202", 35.7101, 139.5243], // 立川市
  ["13203", 35.6716, 139.4761], // 武蔵野市
  ["13204", 35.6836, 139.5592], // 三鷹市
  ["13210", 35.6487, 139.5416], // 町田市
  // 神奈川県
  ["14100", 35.4478, 139.6425], // 横浜市
  ["14130", 35.5313, 139.7030], // 川崎市
  ["14150", 35.3294, 139.5501], // 相模原市
  ["14201", 35.3398, 139.0901], // 横須賀市
  ["14204", 35.3413, 139.3451], // 藤沢市
  // 埼玉県
  ["11100", 35.8617, 139.6455], // さいたま市
  ["11201", 35.9076, 139.4812], // 川越市
  ["11202", 35.9613, 139.5889], // 熊谷市
  ["11203", 35.8340, 139.7188], // 川口市
  // 千葉県
  ["12100", 35.6073, 140.1063], // 千葉市
  ["12203", 35.7564, 139.8743], // 市川市
  ["12204", 35.7104, 139.9973], // 船橋市
  ["12207", 35.7815, 139.8903], // 松戸市
  ["12217", 35.8676, 139.9709], // 柏市
  // 大阪府
  ["27100", 34.6937, 135.5023], // 大阪市
  ["27140", 34.8042, 135.5943], // 堺市
  ["27202", 34.8186, 135.5146], // 豊中市
  ["27203", 34.7549, 135.4543], // 池田市
  ["27204", 34.7609, 135.5613], // 吹田市
  ["27205", 34.7525, 135.6073], // 泉大津市
  ["27207", 34.8514, 135.6001], // 高槻市
  ["27210", 34.8152, 135.5731], // 茨木市
  ["27227", 34.6460, 135.5960], // 東大阪市
  // 愛知県
  ["23100", 35.1815, 136.9066], // 名古屋市
  ["23201", 34.9560, 136.9116], // 豊橋市
  ["23202", 34.9662, 137.1620], // 岡崎市
  ["23204", 35.2514, 136.9686], // 春日井市
  ["23211", 35.0842, 136.9789], // 豊田市
  // 福岡県
  ["40100", 33.5904, 130.4017], // 福岡市
  ["40130", 33.8835, 130.8753], // 北九州市
  ["40203", 33.3154, 130.5088], // 久留米市
  // 北海道
  ["01100", 43.0621, 141.3544], // 札幌市
  ["01202", 43.7696, 142.3650], // 旭川市
  ["01203", 42.9849, 141.0145], // 小樽市
  // 宮城県
  ["04100", 38.2682, 140.8694], // 仙台市
  // 広島県
  ["34100", 34.3963, 132.4596], // 広島市
  // 京都府
  ["26100", 35.0116, 135.7681], // 京都市
  // 兵庫県
  ["28100", 34.6901, 135.1956], // 神戸市
  ["28201", 34.7353, 135.3433], // 姫路市
  ["28202", 34.7371, 135.4064], // 尼崎市
  ["28204", 34.7975, 135.3607], // 西宮市
  // 静岡県
  ["22100", 34.9769, 138.3831], // 静岡市
  ["22130", 34.7108, 137.7261], // 浜松市
  // 新潟県
  ["15100", 37.9161, 139.0364], // 新潟市
  // 岡山県
  ["33100", 34.6618, 133.9350], // 岡山市
  // 熊本県
  ["43100", 32.7898, 130.7417], // 熊本市
];

export const CITY_LOCATIONS: ReadonlyMap<string, CityLocation> = new Map(
  LOCATIONS.map(([code, lat, lng]) => [code, { lat, lng }]),
);

/** ランタイムキャッシュ（ジオコーディング結果を保持） */
const runtimeCache = new Map<string, CityLocation>();

/** 市区町村コードから代表地点を取得する。未登録の場合はnullを返す。 */
export function getCityLocation(areaCode: string): CityLocation | null {
  return CITY_LOCATIONS.get(areaCode) ?? runtimeCache.get(areaCode) ?? null;
}

/**
 * 市区町村コードから代表地点を取得する（非同期版）。
 * 静的テーブルに無い場合、cityNameが指定されていれば国土地理院APIでフォールバック取得する。
 */
export async function getCityLocationAsync(
  areaCode: string,
  cityName?: string,
): Promise<CityLocation | null> {
  const cached = getCityLocation(areaCode);
  if (cached) {
    return cached;
  }

  if (!cityName) {
    return null;
  }

  const location = await geocodeCityName(cityName);
  if (location) {
    runtimeCache.set(areaCode, location);
  }
  return location;
}
